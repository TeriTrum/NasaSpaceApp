<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/css/register.css" />
  <link rel="stylesheet" href="/css/login.css">
  <title>Create account</title>
</head>

<body class="auth-bg register-page">
  <div class="reg-card">
    <div class="reg-header">
      <h2>Let's get started</h2>
      <p>First, create your account.</p>
    </div>

    <div id="flash" class="flash" style="display:none"></div>

    <form id="register-form" autocomplete="on" novalidate>
      <div class="reg-group">
        <label for="email">Your email address</label>
        <input id="email" name="email" type="email" required autocomplete="email" />
        <small class="hint">Use this email to receive OTP when you forget your password.</small>
      </div>

      <div class="reg-group">
        <label for="username">Choose a username</label>
        <input id="username" name="username" type="text" required autocomplete="username" />
        <small class="hint">Letters/numbers only, 3‚Äì32 characters.</small>
      </div>

      <div class="reg-group">
        <label for="password">Choose a password</label>
        <div class="reg-password-wrap">
          <input id="password" name="password" type="password" required autocomplete="new-password" minlength="6" />
          <button type="button" class="pw-toggle" onclick="togglePw()">üëÅ</button>
        </div>
        <small class="hint">Minimum 6 characters.</small>
      </div>

      <p class="reg-terms">
        By creating an account, you agree to our
        <a href="#">Terms of Service</a>.
      </p>

      <button type="submit" class="reg-btn" id="btnCreate">Create your account</button>
    </form>

    <div class="reg-or">Or create an account using:</div>

    <button class="google-btn" id="google-register-btn">
      <span class="google-icon"></span>
      Continue with Google
    </button>

    <div class="reg-bottom">
      Already have an account?
      <a href="/login">Sign in</a>
    </div>
  </div>

  <script>
    function togglePw() {
      const pw = document.getElementById('password');
      pw.type = pw.type === 'password' ? 'text' : 'password';
    }

    // Prefill t·ª´ t√†i kho·∫£n d√πng g·∫ßn nh·∫•t (n·∫øu c√≥)
    (function prefill() {
      try {
        const last = localStorage.getItem('lastIdentifier');
        if (last && last.includes('@')) {
          const e = document.getElementById('email');
          if (e && !e.value) e.value = last;
        } else if (last) {
          const u = document.getElementById('username');
          if (u && !u.value) u.value = last;
        }
      } catch { }
    })();

    const form = document.getElementById('register-form');
    const flash = document.getElementById('flash');
    const btn = document.getElementById('btnCreate');

    function showFlash(msg, ok = false) {
      if (!flash) return;
      flash.style.display = 'block';
      flash.style.color = ok ? '#16a34a' : '#dc2626';
      flash.textContent = msg;
    }

    function validateEmail(v) {
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
    }
    function validateUsername(v) {
      return /^[a-zA-Z0-9_]{3,32}$/.test(v);
    }

    let submitting = false;

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (submitting) return;

      const email = document.getElementById('email').value.trim().toLowerCase();
      const username = document.getElementById('username').value.trim().toLowerCase();
      const password = document.getElementById('password').value;

      // Ki·ªÉm tra nhanh ph√≠a client
      if (!validateEmail(email)) {
        showFlash('Invalid email.', false); return;
      }
      if (!validateUsername(username)) {
        showFlash('Username must contain only letters/numbers/_, 3‚Äì32 characters.', false); return;
      }
      if (!password || password.length < 6) {
        showFlash('Password must be at least 6 characters.', false); return;
      }

      btn.disabled = true; submitting = true;

      try {
        const res = await fetch('/register', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, username, password })
        });

        const ct = res.headers.get('content-type') || '';
        if (!ct.includes('application/json')) {
          // Fallback n·∫øu server redirect b·∫•t ng·ªù
          window.location.href = '/login';
          return;
        }

        const data = await res.json();
        if (data.success) {
          // nh·ªõ identifier ƒë·ªÉ trang login t·ª± fill
          try { localStorage.setItem('lastIdentifier', data.username || username); } catch { }
          showFlash('Account created successfully.Go to login page...', true);
          const u = encodeURIComponent(data.username || username);
          setTimeout(() => {
            window.location.href = `/login?registered=1&u=${u}`;
          }, 600);
        } else {
          showFlash(data.message || 'Registration failed.', false);
        }
      } catch (err) {
        showFlash('Request failed. Please try again.', false);
      } finally {
        submitting = false; btn.disabled = false;
      }
    });

    document.getElementById('google-register-btn').addEventListener('click', () => {
      window.location.href = '/auth/google';
    });
  </script>
</body>

</html>